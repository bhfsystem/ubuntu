#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  cd "$shome"

  "$shome/script/update"

  local vip_cache=
  if ifconfig vboxnet0 2>/dev/null; then	
    vip_cache="172.28.128.1"
  else
    vip_cache="172.28.130.1"
  fi

  case "$(uname -s)" in
    Darwin)
      echo 'server=/dc1.consul/127.0.0.1#5354' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo "address=/nih/$vip_cache" | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo 'server=8.8.4.4' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      brew services restart dnsmasq
      ;;
    *)
      echo 'server=/dc1.consul/127.0.0.1#5354' | sudo tee /etc/dnsmasq.d/nih
      echo "address=/nih/$vip_cache" | sudo tee -a /etc/dnsmasq.d/nih
      echo 'server=8.8.4.4' | sudo tee -a /etc/dnsmasq.d/nih
      sudo systemctl restart dnsmasq
      echo "DOCKER_OPTS="--dns $vip_cache"" | sudo tee /etc/default/docker
      sudo systemctl restart docker
      ;;
  esac
}

main "$@"
