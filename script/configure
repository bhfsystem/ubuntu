#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  cd "$shome"

  local nm_network='ubuntu_default'

  local nm_network_found="$(docker network inspect "$nm_network" | jq -r '.[].Name')"

  if [[ "$nm_network_found" != "$nm_network" ]]; then
    make up || true
  fi

  nm_network_found="$(docker network inspect "$nm_network" | jq -r '.[].Name')"
  if [[ "$nm_network_found" != "$nm_network" ]]; then
    echo "ERROR: could not bring up docker network $nm_network" 1>&2
    return 1
  fi

  "$shome/script/update"

  if ifconfig vboxnet0 2>/dev/null; then	
    vip_cache="172.28.128.1"
  else
    if [[ -n "${1:-}" ]]; then
      vip_cache="$1"; shift
    else
      vip_cache="172.28.130.1"
    fi
  fi

  case "$(uname -s)" in
    Darwin)
      echo 'server=/dc1.consul/127.0.0.1#5354' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo "address=/nih/$vip_cache" | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo 'server=8.8.4.4' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      brew services restart dnsmasq
      ;;
    *)
      sudo iptables -t nat -A POSTROUTING -s "$(docker network inspect "$nm_network" | jq -r '.[].IPAM.Config[].Subnet')" ! -o "$(facts | jq -r --arg gateway "$(docker network inspect "$nm_network" | jq -r '.[].IPAM.Config[].Gateway')"  'map(select(type == "object")) | map(select(.type == "bridge")) | map(select({gateway: .ipv4.address} == {gateway: $gateway})) | .[].device')" -j MASQUERADE
      sudo sysctl -w net.ipv4.ip_forward=1
    
      echo 'server=/dc1.consul/127.0.0.1#5354' | sudo tee /etc/dnsmasq.d/nih
      echo "address=/nih/$vip_cache" | sudo tee -a /etc/dnsmasq.d/nih
      sudo systemctl restart dnsmasq
      echo "DOCKER_OPTS=\"--dns $vip_cache --iptables=false\"" | sudo tee /etc/default/docker
      sudo systemctl restart docker
      ;;
  esac

  if [[ ! -f /config/ssh/authorized_keys ]]; then
    mkdir -p /config/ssh
    rsync -ia ~/.ssh/authorized_keys /config/ssh/authorized_keys
  fi
}

main "$@"
