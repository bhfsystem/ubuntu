#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  cd "$shome"

  local nm_network="$(docker network inspect ubuntu_default | jq -r '.[].Name')"

  if [[ "$nm_network" != "ubuntu_default" ]]; then
    make up || true
  fi
  
  nm_network="$(docker network inspect ubuntu_default | jq -r '.[].Name')"
  if [[ "$nm_network" != "ubuntu_default" ]]; then
    echo "ERROR: could not bring up docker network for ubuntu" 1>&2
    return 1
  fi

  "$shome/script/update"

  if ifconfig vboxnet0 2>/dev/null; then	
    vip_cache="172.28.128.1"
  else
    if [[ -n "${1:-}" ]]; then
      vip_cache="$1"; shift
    else
      vip_cache="172.28.130.1"
    fi
  fi

  case "$(uname -s)" in
    Darwin)
      echo 'server=/dc1.consul/127.0.0.1#5354' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo "address=/nih/$vip_cache" | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo 'server=8.8.4.4' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      brew services restart dnsmasq
      ;;
    *)
      echo 'server=/dc1.consul/127.0.0.1#5354' | sudo tee /etc/dnsmasq.d/nih
      echo "address=/nih/$vip_cache" | sudo tee -a /etc/dnsmasq.d/nih
      sudo systemctl restart dnsmasq
      echo "DOCKER_OPTS=\"--dns $vip_cache --iptables=false\"" | sudo tee /etc/default/docker
      sudo systemctl restart docker
      ;;
  esac

  if [[ ! -f /config/ssh/authorized_keys ]]; then
    mkdir -p /config/ssh
    rsync -ia ~/.ssh/authorized_keys /config/ssh/authorized_keys
  fi
}

main "$@"
