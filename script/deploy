#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  set -exfu

  "$@" -o StrictHostKeychecking=no -- ssh -o StrictHostKeyChecking=no github.com 2>/dev/null || true
  if "$@" test -d .git; then
    true
  else
    "$@" -A git clone git@github.com:imma/ubuntu-home
    "$@" mv ubuntu-home/.git .
    "$@" rm -rf ubuntu-home
    "$@" git reset --hard
  fi
  "$@" -A script/cibuild
  "$@" make cache
}

main "$@"
