#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  set -exfu

  "$@" sudo install -d -o ubuntu -g ubuntu /data
  "$@" sudo install -d -o ubuntu -g ubuntu /data/cache
  "$@" sudo install -d -o ubuntu -g ubuntu /config

  if "$@" test -d .git; then
    true
  else
    "$@" -A git clone git@github.com:imma/ubuntu
    "$@" mv ubuntu/.git .
    "$@" rm -rf ubuntu
    "$@" git reset --hard
  fi

  if "$@" systemctl; then
    while true; do
      if "$@" test -f "/var/lib/cloud/instance/boot-finished"; then break; fi
      echo "Waiting for cloud-init boot-finished: $(date)"
      sleep 3
    done
  fi

  if ! "$@" -A script/cibuild; then
    "$@" make cache
    "$@" home disable cache
    "$@" -A script/cibuild
    "$@" home enable cache
  fi
  
  "$@" make cache
}

main "$@"
