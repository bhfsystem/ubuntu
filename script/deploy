#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  set -exfu

  if ! "$@" test -d .git; then
    "$@" -A ssh -o StrictHostKeyChecking=no git@github.com true 2>/dev/null || true

    "$@" -A git clone -b "$(cd "$shome" && git rev-parse --abbrev-ref HEAD)" git@github.com:imma/ubuntu
    "$@" mv ubuntu/.git .
    "$@" rm -rf ubuntu
    "$@" git reset --hard
  fi

  if ! "$@" test -d /config/.git; then
    "$@" sudo install -d -o ubuntu -g ubuntu /data
    "$@" sudo install -d -o ubuntu -g ubuntu /data/cache
    "$@" sudo install -d -o ubuntu -g ubuntu /config
    "$@" -A git clone -b "$(cd "$shome" && git rev-parse --abbrev-ref HEAD)" git@github.com:imma/imma-config /config
  fi

  if "$@" curl -s http://cache.nih | grep Nexus; then
    "$@" home enable cache 2>/dev/null || true
  fi

  "$@" make sync cache
  "$@" script/cibuild

  if "$@" curl -s http://cache.nih | grep Nexus; then
    "$@" home disable cache
  fi
}

main "$@"
