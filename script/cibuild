#!/usr/bin/env bash

function setup_submodules {
  if ! git submodule update --init --remote --no-fetch -j 10; then
    git submdule update --init
  fi
  git submodule foreach git checkout master
}

function setup_block {
  if [[ ! -d "$shome/work/block/.git" ]]; then
    (cd "$shome/work" && git clone git@github.com:imma/block)
  fi
  "$shome/work/block/script/cibuild"
  source "$shome/work/block/script/profile"
}

function build_blocks {
  cd ~
  require
  home update
  "$shome/work/block/script/cibuild" ~
}

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"

  setup_submodules
  setup_block
  require
  home update
  build_blocks
  make cache
}

main "$@"
